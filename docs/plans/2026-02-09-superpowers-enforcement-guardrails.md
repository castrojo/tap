# Superpowers Workflow Enforcement & Quality Guardrails Plan

**Date:** 2026-02-09  
**Status:** Ready for Implementation  
**Priority:** ğŸ”´ CRITICAL - Blocks reliable AI agent automation

---

## Executive Summary

**Problem:** AI agents are bypassing the mandatory homebrew-packaging skill workflow, leading to catastrophic failures like PR #22 (architectural errors that would fail at install time).

**Root Cause:** No technical enforcement prevents manual package creation. Agents can ignore documentation and create invalid packages that pass style checks but have semantic errors.

**Solution:** Multi-layered defense with **technical enforcement** at every stage:
1. **Generation layer:** Tools add metadata proving they were used
2. **Commit layer:** Pre-commit hooks validate metadata exists
3. **CI layer:** Semantic validation catches architectural errors
4. **GitHub layer:** Branch protection enforces PR workflow

**Impact:** Zero CI failures, 100% workflow compliance, eliminate catastrophic errors

---

## Current State Analysis

### What's Working âœ…
- Excellent documentation (skill, AGENTS.md, copilot-instructions.md)
- Go tools with built-in validation (tap-cask, tap-formula, tap-validate)
- Pre-commit hooks (when installed locally)
- CI validation with brew audit/style

### Critical Gaps âŒ
- **No detection** of manual file creation vs tool-generated
- **No enforcement** that tools are actually used
- **No semantic validation** (only style checks)
- **No branch protection** (can commit directly to main)
- **Skills are optional** (agents can ignore loading instructions)
- **No PR workflow enforcement** (direct commits bypass review)

### Failure Analysis

| PR | Type | Root Cause | Impact |
|---|---|---|---|
| #18 | Style | Regex vs string | CI fail (fixable) |
| #19 | Semantic | Invalid license stanza | CI fail (moderate) |
| #22 | Catastrophic | Manual creation, binary with target, Dir.home | Install-time failure |

**Pattern:** Each failure escalates in severity. PR #22 would have **failed at install time**, not just CI.

---

## Recommended Guardrails (4 Phases)

### ğŸš€ Phase 1: Quick Wins (Deploy Today - 3 hours)

**Goal:** Technical enforcement of tool usage + catch architectural errors

#### 1.1 Add "Generated By" Header to Tools â­â­â­
**Impact:** Immediate detection of manual creation  
**Effort:** 1 hour

**Implementation:**
```go
// tap-tools/internal/generator/header.go
package generator

import (
	"fmt"
	"io"
	"time"
)

const Version = "1.0.0"

func WriteHeader(w io.Writer, toolName, sourceURL string) {
	fmt.Fprintf(w, "# Generated by %s v%s on %s\n", toolName, Version, time.Now().Format("2006-01-02"))
	fmt.Fprintf(w, "# Source: %s\n", sourceURL)
	fmt.Fprintf(w, "# DO NOT EDIT - Regenerate with: ./%s generate %s\n", toolName, sourceURL)
	fmt.Fprintf(w, "# Validation: Auto-validated with tap-validate --fix\n")
	fmt.Fprintf(w, "\n")
}
```

**Update generators:**
```go
// tap-tools/cmd/tap-cask/generate.go
func (g *Generator) Generate() error {
	f, _ := os.Create(outputPath)
	defer f.Close()
	
	// Write header FIRST
	generator.WriteHeader(f, "tap-cask", g.repoURL)
	
	// Then write cask content
	fmt.Fprintf(f, "cask \"%s-linux\" do\n", name)
	// ... rest of generation
}
```

**Files to modify:**
- `tap-tools/cmd/tap-cask/generate.go`
- `tap-tools/cmd/tap-formula/generate.go`
- `tap-tools/internal/generator/header.go` (new file)

#### 1.2 Add Semantic Validation to CI â­â­â­
**Impact:** Blocks PR #22-style catastrophic errors  
**Effort:** 1 hour

**Implementation:**
```yaml
# .github/workflows/tests.yml - add before brew audit
      - name: Semantic validation
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ” Checking for architectural errors..."
          FAILED=0
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "â†’ Validating $file"
            
            # Check 1: Must have "Generated by" header
            if ! grep -q "^# Generated by tap-" "$file"; then
              echo "âŒ $file: Missing 'Generated by' header"
              echo "   This package was not created with tap-tools"
              echo "   Solution: ./tap-tools/tap-cask generate <url>"
              FAILED=1
            fi
            
            # Check 2: No binary with target parameter
            if grep -q 'binary.*target:' "$file"; then
              echo "âŒ $file: 'binary' does not support 'target:' parameter"
              echo "   Use 'artifact' stanza instead"
              FAILED=1
            fi
            
            # Check 3: No Dir.home usage (must use ENV.fetch("HOME"))
            if grep -q 'Dir\.home' "$file"; then
              echo "âŒ $file: Use ENV.fetch(\"HOME\") instead of Dir.home"
              echo "   Dir.home hardcodes username and breaks for other users"
              FAILED=1
            fi
            
            # Check 4: No invalid depends_on syntax
            if grep -q 'depends_on formula:' "$file"; then
              echo "âŒ $file: Invalid depends_on syntax"
              echo "   Remove 'formula:' - use 'depends_on \"package-name\"'"
              FAILED=1
            fi
            
            # Check 5: Casks must have -linux suffix
            if [[ "$file" == Casks/* ]]; then
              basename=$(basename "$file" .rb)
              if [[ ! "$basename" =~ -linux$ ]]; then
                echo "âŒ $file: Cask name must end with '-linux'"
                echo "   Prevents collision with official macOS casks"
                FAILED=1
              fi
            fi
          done
          
          if [ $FAILED -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ CRITICAL: Package has architectural errors"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "These errors would cause install-time failures."
            echo ""
            echo "To fix:"
            echo "  1. Delete the manually-created file"
            echo "  2. Regenerate: ./tap-tools/tap-cask generate <url>"
            echo "  3. Commit the tool-generated file"
            echo ""
            exit 1
          fi
          
          echo "âœ… All semantic validation checks passed"
```

**Files to modify:**
- `.github/workflows/tests.yml`

#### 1.3 Update Pre-commit Hook â­â­
**Impact:** Local validation before CI  
**Effort:** 30 minutes

**Implementation:**
```bash
# scripts/git-hooks/pre-commit
#!/bin/bash
# Pre-commit hook: Validate Ruby files

# ... existing validation ...

# Add semantic validation
echo "â†’ Checking for architectural errors..."
for file in $STAGED_RUBY_FILES; do
  if ! grep -q "^# Generated by tap-" "$file"; then
    echo "âŒ $file: Missing 'Generated by' header"
    echo "   Use tap-tools to create packages, not manual creation"
    exit 1
  fi
  
  if grep -q 'binary.*target:' "$file"; then
    echo "âŒ $file: binary does not support target: parameter"
    exit 1
  fi
  
  if grep -q 'Dir\.home' "$file"; then
    echo "âŒ $file: Use ENV.fetch(\"HOME\") not Dir.home"
    exit 1
  fi
done
```

**Files to modify:**
- `scripts/git-hooks/pre-commit`

#### 1.4 Add PR Template â­
**Impact:** Makes workflow violations obvious  
**Effort:** 15 minutes

**Implementation:**
```markdown
# .github/PULL_REQUEST_TEMPLATE.md
## Package Creation Checklist

**I confirm that I:**
- [ ] Used `./tap-tools/tap-cask generate` or `./tap-tools/tap-formula generate`
- [ ] Saw "âœ“ Validation passed" before committing
- [ ] Did NOT manually write this package
- [ ] File has "Generated by tap-*" comment header
- [ ] Pre-commit hook passed (or ran `./tap-tools/tap-validate --fix`)
- [ ] Followed the packaging skill workflow from `.github/skills/homebrew-packaging/SKILL.md`

## Generation Details

- **Tool used:** tap-cask / tap-formula
- **Command run:** `./tap-tools/tap-cask generate <url>`
- **Validation result:** Passed / Passed with auto-fix

## Package Details

- **Package name:** 
- **Version:** 
- **Type:** Cask / Formula
- **Source URL:** 

## Testing

- [ ] Package validated with `tap-validate`
- [ ] SHA256 verified from upstream
- [ ] Desktop integration tested (for GUI apps)
- [ ] Binary execution tested (if applicable)

## Related Issues

Fixes #

---

**Note:** If any checkbox above is unchecked, this PR may fail CI or cause install-time failures.
```

**Files to create:**
- `.github/PULL_REQUEST_TEMPLATE.md`

#### 1.5 Enable Branch Protection â­â­â­
**Impact:** Forces PR workflow, enables review  
**Effort:** 5 minutes

**Settings to enable via GitHub UI or API:**
```bash
gh api repos/castrojo/tap/branches/main/protection -X PUT --input - <<EOF
{
  "required_status_checks": {
    "strict": true,
    "contexts": [
      "test / Run brew audit",
      "test / Run brew style",
      "test / Semantic validation"
    ]
  },
  "enforce_admins": false,
  "required_pull_request_reviews": {
    "required_approving_review_count": 0,
    "dismiss_stale_reviews": false
  },
  "restrictions": null,
  "allow_force_pushes": false,
  "allow_deletions": false,
  "required_conversation_resolution": true
}
EOF
```

**Alternatively via GitHub UI:**
1. Go to: Settings â†’ Branches â†’ Branch protection rules
2. Add rule for `main`
3. Enable:
   - Require a pull request before merging
   - Require status checks to pass
   - Require conversation resolution

---

### Phase 1 Summary

**Total Effort:** 3 hours  
**Files Modified:** 5 files  
**Files Created:** 2 files

**Expected Results:**
- âœ… 100% detection of manual creation (header check)
- âœ… 100% prevention of architectural errors (semantic validation)
- âœ… 100% PR workflow enforcement (branch protection)
- âœ… Immediate feedback to agents (pre-commit hook)

**Success Criteria:**
- PR #22-style errors: **Cannot happen** (blocked by CI)
- Manual creation: **Cannot merge** (blocked by header check)
- Direct main commits: **Cannot happen** (blocked by branch protection)

---

### ğŸ”§ Phase 2: Enhanced Tools (Next Week - 8 hours)

**Goal:** Comprehensive semantic validation tool

#### 2.1 Create tap-audit Tool
**Purpose:** Dedicated semantic validation beyond style checks

**Features:**
- Validate "Generated by" header exists
- Check all prohibited patterns
- Verify XDG compliance
- Validate stanza ordering
- Check required fields
- Test file would install correctly

**Implementation:**
```bash
./tap-tools/tap-audit check Casks/app-linux.rb
./tap-tools/tap-audit check --all  # Check all packages
./tap-tools/tap-audit fix Casks/app-linux.rb  # Auto-fix if possible
```

**Checks performed:**
1. Header validation (Generated by, version, source)
2. Prohibited patterns (binary with target, Dir.home, invalid depends_on)
3. XDG environment variable usage
4. Cask naming (-linux suffix)
5. SHA256 verification present
6. Required stanzas exist
7. Stanzas in correct order
8. Description quality (no marketing fluff)
9. Array ordering (alphabetical)
10. Line length (max 118 chars)

**Integration:**
- Add to CI (before brew audit)
- Add to pre-commit hook
- Used by generators during generation

#### 2.2 Enhanced Pre-commit Hook
**Purpose:** Run tap-audit locally

**Benefits:**
- Faster feedback (seconds vs minutes)
- Catches issues before CI
- Provides fix suggestions

---

### ğŸ§ª Phase 3: Installation Testing (2 Weeks - 6 hours)

**Goal:** Verify packages actually install and work

#### 3.1 Add Smoke Tests to CI
**Purpose:** Actually test installation in CI

**Implementation:**
```yaml
- name: Test installation
  run: |
    for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
      name=$(basename "$file" .rb)
      if [[ "$file" == Casks/* ]]; then
        echo "â†’ Testing cask: $name"
        brew install --cask "castrojo/tap/$name"
        
        # Verify desktop file (GUI apps)
        if [ -f ~/.local/share/applications/${name%.linux}.desktop ]; then
          echo "âœ“ Desktop file installed"
        fi
        
        # Verify icon
        if find ~/.local/share/icons -name "*${name}*" | grep -q .; then
          echo "âœ“ Icon installed"
        fi
        
        # Test uninstall
        brew uninstall --cask "castrojo/tap/$name"
        echo "âœ“ Uninstall successful"
      fi
    done
```

**Benefits:**
- Catches runtime failures
- Verifies desktop integration
- Tests uninstall process

---

### ğŸ¤– Phase 4: AI Agent Enforcement (1 Month - 16 hours)

**Goal:** Automate package creation entirely

#### 4.1 Packaging Assistant GitHub Action
**Purpose:** Automated package creation from issues

**Workflow:**
1. Issue labeled "package-request"
2. Action automatically processes with `tap-issue`
3. Creates PR with tool-generated package
4. Comments on issue with PR link
5. Gemini reviews PR automatically

**Benefits:**
- Removes variability from agent behavior
- Guaranteed workflow compliance
- Faster turnaround time

#### 4.2 Skill Compliance Bot
**Purpose:** Analyze PRs for workflow compliance

**Features:**
- Checks for "Generated by" header
- Verifies conventional commit format
- Confirms AI attribution footer
- Validates PR description includes testing details

**Output:**
- âœ… Comment if fully compliant
- âš ï¸ Comment with missing steps if non-compliant

---

## Implementation Timeline

| Phase | Duration | Start | Complete | Status |
|-------|----------|-------|----------|--------|
| Phase 1 | 3 hours | 2026-02-09 | 2026-02-09 | ğŸŸ¡ Ready |
| Phase 2 | 8 hours | 2026-02-11 | 2026-02-11 | ğŸ”µ Planned |
| Phase 3 | 6 hours | 2026-02-18 | 2026-02-18 | ğŸ”µ Planned |
| Phase 4 | 16 hours | 2026-03-01 | 2026-03-08 | ğŸ”µ Planned |

---

## Success Metrics

### Current Baseline (Pre-Guardrails)
- PR CI success rate: **33%** (1 of 3 passed first try)
- Manual creation rate: **Unknown** (no detection)
- Catastrophic errors: **33%** (PR #22)
- Average commits to merge: **2-3 rounds**

### Target: After Phase 1 (Technical Enforcement)
- PR CI success rate: **>90%**
- Manual creation rate: **0%** (blocked by CI)
- Catastrophic errors: **0%** (semantic validation)
- Average commits to merge: **1-2 rounds**

### Target: After Phase 3 (Installation Testing)
- PR CI success rate: **100%**
- Installation failure rate: **<5%**
- Catastrophic errors: **0%**
- Average commits to merge: **1 round**

### Target: After Phase 4 (Full Automation)
- Human/AI intervention: **Minimal** (only edge cases)
- Issue â†’ Merged PR time: **<30 minutes**
- Zero errors: **100%**

---

## Risk Mitigation

### Risk 1: Agents bypass checks with --no-verify
**Mitigation:** 
- Pre-commit hook message warns against it
- CI still catches issues
- GitHub branch protection prevents direct commits

### Risk 2: Tools generate invalid packages
**Mitigation:**
- Validation is part of generation
- Multiple validation layers (tool â†’ hook â†’ CI)
- Smoke tests catch runtime failures

### Risk 3: Documentation drift
**Mitigation:**
- Single source of truth (skill file)
- Tools reference skill in error messages
- Automated checks verify compliance

### Risk 4: Performance impact from checks
**Mitigation:**
- Pre-commit hook is fast (<5 seconds)
- CI semantic validation is simple grep (<10 seconds)
- Only runs on changed files

---

## Next Steps

### Immediate (Today)
1. âœ… Review and merge PR #23 (GitHub token fix)
2. ğŸ”µ Implement Phase 1.1: Add headers to generators
3. ğŸ”µ Implement Phase 1.2: Add semantic CI validation
4. ğŸ”µ Implement Phase 1.3: Update pre-commit hook
5. ğŸ”µ Implement Phase 1.4: Add PR template
6. ğŸ”µ Implement Phase 1.5: Enable branch protection

### This Week
7. Build tap-audit tool (Phase 2)
8. Integrate tap-audit into generators
9. Test with 2-3 real package creation scenarios

### This Month
10. Add installation smoke tests (Phase 3)
11. Create packaging assistant action (Phase 4)
12. Monitor and iterate based on results

---

## Open Questions

1. **Should we allow emergency --no-verify bypass for maintainers?**
   - Recommendation: Yes, but log it and require justification in commit message

2. **Should semantic validation be auto-fixing or error-only?**
   - Recommendation: Error-only for Phase 1, auto-fix in Phase 2 with tap-audit

3. **Should we require PR approvals or just status checks?**
   - Recommendation: Status checks only (0 approvals), allows self-merge but forces PR workflow

4. **Should we create separate workflows for formulas vs casks?**
   - Recommendation: No, single workflow with conditional logic based on file path

---

## Related Documentation

- `.github/skills/homebrew-packaging/SKILL.md` - Primary workflow source
- `docs/observations/2026-02-09-pr-22-catastrophic-failure-analysis.md` - What we're preventing
- `docs/plans/2026-02-09-copilot-skill-enforcement-strategy.md` - Original enforcement ideas
- `docs/plans/2026-02-09-zero-error-packages-design.md` - Long-term vision

---

**Status:** Ready for Phase 1 implementation  
**Next Action:** Address Gemini feedback on PR #23, then begin Phase 1.1  
**Owner:** Development team  
**Review Date:** 2026-02-11 (after Phase 1 complete)
