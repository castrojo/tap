#!/bin/bash
# Pre-commit hook: Validate Ruby files before commit
# This hook prevents committing invalid Ruby files that would fail CI

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "ğŸ” Running pre-commit validation..."

# Check if tap-validate exists
if [ ! -f "./tap-tools/tap-validate" ]; then
    echo -e "${RED}âœ— tap-validate not found!${NC}"
    echo "Build it with: cd tap-tools && go build"
    exit 1
fi

# Get staged Ruby files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(rb)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ“ No Ruby files to validate${NC}"
    exit 0
fi

VALIDATION_FAILED=0

for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        echo ""
        echo "Validating: $FILE"
        
        # Semantic validation checks
        echo "â†’ Checking for architectural errors..."
        
        # Check for generated header
        if ! grep -q "^# Generated by tap-" "$FILE"; then
            echo -e "${RED}âŒ $FILE: Missing 'Generated by' header${NC}"
            echo "   Use tap-tools to create packages, not manual creation"
            echo "   Run: ./tap-tools/tap-cask generate <url>"
            VALIDATION_FAILED=1
            continue
        fi
        
        # Check for prohibited patterns
        if grep -q 'binary.*target:' "$FILE"; then
            echo -e "${RED}âŒ $FILE: binary does not support target: parameter${NC}"
            echo "   Use 'artifact' stanza instead"
            VALIDATION_FAILED=1
            continue
        fi
        
        if grep -q 'Dir\.home' "$FILE"; then
            echo -e "${RED}âŒ $FILE: Use ENV.fetch(\"HOME\") not Dir.home${NC}"
            VALIDATION_FAILED=1
            continue
        fi
        
        if grep -q 'depends_on formula:' "$FILE"; then
            echo -e "${RED}âŒ $FILE: Invalid depends_on syntax${NC}"
            VALIDATION_FAILED=1
            continue
        fi
        
        # Check cask naming convention
        if [[ "$FILE" == Casks/* ]]; then
            basename=$(basename "$FILE" .rb)
            if [[ ! "$basename" =~ -linux$ ]]; then
                echo -e "${RED}âŒ $FILE: Cask name must end with '-linux'${NC}"
                VALIDATION_FAILED=1
                continue
            fi
        fi
        
        # Run style validation with --fix
        if ./tap-tools/tap-validate file "$FILE" --fix 2>&1; then
            echo -e "${GREEN}âœ“ $FILE passed validation${NC}"
            
            # Re-stage file if it was auto-fixed
            git add "$FILE"
        else
            echo -e "${RED}âœ— $FILE failed validation${NC}"
            VALIDATION_FAILED=1
        fi
    fi
done

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘  COMMIT BLOCKED: Style validation failed                  â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo "Some files failed validation. Please fix the issues and try again."
    echo ""
    echo "To fix automatically:"
    echo "  ./tap-tools/tap-validate file <filename> --fix"
    echo ""
    echo "To bypass this hook (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

echo ""
echo -e "${GREEN}âœ… All validations passed!${NC}"
exit 0
